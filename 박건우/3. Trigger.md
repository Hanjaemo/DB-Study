# 3. Trigger (트리거)

**데이터베이스에서 어떤 이벤트가 발생했을시 자동적으로 실행되는 프로시저**

즉

데이터에 변경이 생겼을 때 (insert, update, delete),

이것이 계기가 되어 자동적으로 실행되는 프로시저를 의미한다.

### 예시 : 닉네임 변경 이력 저장

닉네임이 업데이트 될 때 마다, 로그 테이블에 기존닉네임을 저장을 해준다.

```SQL
CREATE TRIGGER log_user_nickname_trigger
BEFORE UPDATE
ON users FOR EACH ROW
BEGIN
    insert into users_log values(OLD.id, OLD.nickname, now());
END
```

- `BEFORE` : 이벤트 이전에 트리거 발생

- `FOR EACH ROW` : 업데이트 되는 각 ROW에 대해 트리거 실행 

- `OLD` : UPDATE 이전의 튜플을 가르킴 (`BEFORE UPDATE` 이기 때문)

### 예시2

```
사용자가 마트에서 상품을 구매할 때 마다

지금까지 누적된 구매 비용을 구하는 트리거를 작성
```

```SQL
CREATE TRIGGER sum_buy_prices_trigger
AFTER INSERT
ON buy FOR EACH ROW
BEGIN
    DECLARE total INT;
    DECLARE user_id INT DEFAULT NEW.user_id;
    
    -- 집계함수를 통해 누적 비용을 total에 저장
    select sum(price) into total from buy where user_id = user_id; 
    -- 누적 비용을 update
    update user_buy_stats set price_sum = total where user_id = user_id 
END
```

- `NEW` : 여기선 데이터 insert 이후의 튜플을 가르킴 (앞에 `AFTER INSERT`이기 떄문)

### 참고

- 여러 이벤트를 한번에 감지 할 수 있다. (단 mysql은 안됨)

    - 예시
        ```SQL
            CREATE TRIGGER avg_empl_salary_trigger
            AFTER INSERT OR UPDATE OR DELETE
            ON employee
            FOR EACH ROW
            EXECUTE FUNCTION update_avg_empl_salary();
        ```

    - 위의 경우는 벌크성 업데이트 발생시 트리거가 여러번 수행된다.

        ```SQL
            CREATE TRIGGER avg_empl_salary_trigger
            AFTER INSERT OR UPDATE OR DELETE
            ON employee
            FOR EACH STATEMENT
            EXECUTE FUNCTION update_avg_empl_salary();
        ```

    - 하지만 이 경우는 벌크성 업데이트가 발생해도 한번만 실행된다. 
      (EACH STATEMENT와 EACH ROW의 차이)


## 트리거 사용시 주의사항



